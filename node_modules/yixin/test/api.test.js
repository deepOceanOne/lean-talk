/**
 * Created by fuzesun on 14-5-15.
 */
var nock = require('nock');
var Yixin = require('../');
var utils = require('../lib/utils');
var customContentWrapper = utils.wrapCustomContent;
var groupContentWrapper = utils.wrapGroupContent;
var supports = require('./dependencies');
var menuExample = supports.menu;
var API = Yixin.API;
var should = require('should');
describe("api.js", function () {
  var api = new API('appid', 'secret');

  describe("#getAccessToken", function () {
    before(function () {
      var scope = nock('https://api.yixin.im')
        .filteringPath(/\?(grant_type=[^&]*&appid=[^&]*&secret=[^&]*)|\?(access_token=[^&]*)/g, '')
        .get('/cgi-bin/token')
        .reply(200, {
          access_token: "ACCESS_TOKEN",
          expires_in: 86400
        });
    });
    it('shoud be ok', function (done) {
      api.getAccessToken(function (err, data) {
        should.not.exist(err);
        data.should.have.keys('access_token', 'expires_in');
        done();
      });
    });
  });
  describe('#Menu manage', function () {
    before(function () {
      var scope = nock('https://api.yixin.im')
        .filteringPath(/\?(grant_type=[^&]*&appid=[^&]*&secret=[^&]*)/g, '')
        .get('/cgi-bin/token')
        .reply(200, {
          access_token: "ACCESS_TOKEN",
          expires_in: 86400
        })
        .filteringPath(/\?access_token=[^&]*/g, "")
        .get('/cgi-bin/menu/get', '')
        .reply(200, menuExample)
        .get('/cgi-bin/menu/delete')
        .reply(200, {
          errcode: 0,
          errmsg: 'ok'
        })
        .post('/cgi-bin/menu/create', menuExample)
        .reply(200, {
          errcode: 0,
          errmsg: 'ok'
        });
    });
    describe('##get menu', function () {
      it('should be ok', function (done) {
        api.getMenu(function (err, data) {
          should.not.exist(err);
          data.button.should.eql(menuExample.button);
          done();
        });
      });
    });
    describe('##create menu', function () {
      it('should be ok', function (done) {
        api.createMenu(menuExample, function (err, data) {
          should.not.exist(err);
          data.errcode.should.eql(0);
          data.errmsg.should.eql('ok');
          done();
        });
      });
    });
    describe('##del menu', function () {
      it('should be ok', function (done) {
        api.delMenu(function (err, data) {
          should.not.exist(err);
          data.errcode.should.eql(0);
          data.errmsg.should.eql('ok');
          done();
        });
      });
    })
  });

  describe('#Group manager', function () {
    before(function () {
      var scope = nock('https://api.yixin.im')
        .filteringPath(/\?(grant_type=[^&]*&appid=[^&]*&secret=[^&]*)/g, '')
        .get('/cgi-bin/token', '')
        .reply(200, {
          access_token: "ACCESS_TOKEN",
          expires_in: 86400
        })
        .filteringPath(/\?access_token=[^&]*/g, '')
        .get('/cgi-bin/groups/get', '')
        .reply(200, {
          groups: [
            {id: 0, name: "未分组", count: 2}
          ]
        })
        .post('/cgi-bin/groups/getid', {openid: '1234567'})
        .reply(200, {
          groupid: 102
        })
        .post('/cgi-bin/groups/create', {"group": {"name": "yixingourp"}})
        .reply(200, {group: {id: 123, name: "yixingroup"}})
        .post('/cgi-bin/groups/update', {group: {id: 123, name: "newname"}})
        .reply(200, {
          errcode: 0,
          errmsg: 'ok'
        });
    });
    describe('##createGroup', function () {
      it('should be ok', function (done) {
        api.createGroup("yixingourp", function (err, data) {
          should.not.exist(err);
          data.group.should.have.keys('id', 'name');
          done();
        });
      });
    });
    describe('##get all groups', function () {
      it('should get get group array', function (done) {
        api.getGroups(function (err, data) {
          should.not.exist(err);
          data.groups.should.eql([
            {id: 0, name: "未分组", count: 2}
          ]);
          done();
        });
      });
    });
    describe('##get User\'s group', function () {
      it('should get an id of group', function (done) {
        api.getUserGroupId('1234567', function (err, data) {
          should.not.exist(err);
          data.should.have.keys('groupid');
          done()
        });
      })
    });
    describe('##update User group', function () {
      it('should be ok', function (done) {
        api.updateGroupName(123, 'newname', function (err, data) {
          should.not.exist(err);
          data.errcode.should.eql(0);
          data.errmsg.should.eql('ok');
          done();
        });
      });
    });
  });
  describe('#Send Custom Message', function () {
    var openid = "12345678";
    var text = customContentWrapper(openid, 'text', 'hello');
    var image = customContentWrapper(openid, 'image', 'media_id');
    var video = customContentWrapper(openid, 'video', 'media_id');
    var voice = customContentWrapper(openid, 'voice', 'media_id');
    var articles = [
      {
        "title": "Happy Day",
        "description": "Is Really A Happy Day",
        "url": "URL",
        "picurl": "PIC_URL"
      },
      {
        "title": "Happy Day",
        "description": "Is Really A Happy Day",
        "url": "URL",
        "picurl": "PIC_URL"
      }
    ];
    var news = customContentWrapper(openid, 'news', articles);
    var link = customContentWrapper(openid, 'link', {title: 'title', description: 'description', url: 'http://www.163.com'});
    var card = customContentWrapper(openid, 'card', 'yixinid');
    before(function () {
      var scope = nock('https://api.yixin.im')
        .filteringPath(/\?(grant_type=[^&]*&appid=[^&]*&secret=[^&]*)|\?(access_token=[^&]*)/g, '')
        .get('/cgi-bin/token', '')
        .reply(200, {
          access_token: "ACCESS_TOKEN",
          expires_in: 86400
        })
        .post('/cgi-bin/message/custom/send', text)
        .reply(200, {
          errcode:0,
          errmsg: 'ok'
        })
        .post('/cgi-bin/message/custom/send', image)
        .reply(200, {
          errcode:0,
          errmsg: 'ok'
        }).post('/cgi-bin/message/custom/send', video)
        .reply(200, {
          errcode:0,
          errmsg: 'ok'
        }).post('/cgi-bin/message/custom/send', voice)
        .reply(200, {
          errcode:0,
          errmsg: 'ok'
        }).post('/cgi-bin/message/custom/send', news)
        .reply(200, {
          errcode:0,
          errmsg: 'ok'
        }).post('/cgi-bin/message/custom/send', link)
        .reply(200, {
          errcode:0,
          errmsg: 'ok'
        }).post('/cgi-bin/message/custom/send', card)
        .reply(200, {
          errcode:0,
          errmsg: 'ok'
        });
    });

    describe('## send text', function() {
      it('should be ok', function(done) {
        api.sendText(openid, 'hello', function(err,data) {
          should.not.exist(err);
          data.errcode.should.eql(0);
          data.errmsg.should.eql('ok');
          done();
        });
      });
    });
    describe('## send image', function() {
      it('should be ok', function(done) {
        api.sendImage(openid, 'media_id', function(err,data) {
          should.not.exist(err);
          data.errcode.should.eql(0);
          data.errmsg.should.eql('ok');
          done();
        });
      });
    });
    describe('## send voice', function() {
      it('should be ok', function(done) {
        api.sendVoice(openid, 'media_id', function(err,data) {
          should.not.exist(err);
          data.errcode.should.eql(0);
          data.errmsg.should.eql('ok');
          done();
        });
      });
    });
    describe('## send video', function() {
      it('should be ok', function(done) {
        api.sendVideo(openid, 'media_id', function(err,data) {
          should.not.exist(err);
          data.errcode.should.eql(0);
          data.errmsg.should.eql('ok');
          done();
        });
      });
    });
    describe('## send news', function() {
      it('should be ok', function(done) {
        api.sendNews(openid, articles, function(err,data) {
          should.not.exist(err);
          data.errcode.should.eql(0);
          data.errmsg.should.eql('ok');
          done();
        });
      });
    });
    describe('## send link', function() {
      it('should be ok', function(done) {
        api.sendLink(openid, {title: 'title', description: 'description', url: 'http://www.163.com'}, function(err,data) {
          should.not.exist(err);
          data.errcode.should.eql(0);
          data.errmsg.should.eql('ok');
          done();
        });
      });
    });
    describe('## send card', function() {
      it('should be ok', function(done) {
        api.sendCard(openid, 'yixinid', function(err,data) {
          should.not.exist(err);
          data.errcode.should.eql(0);
          data.errmsg.should.eql('ok');
          done();
        });
      });
    });
  });

  describe('#Send Group Message', function() {
    var groupName = "未分组";
    var text = groupContentWrapper(groupName, 'text', 'hello nodejs');
    var card = groupContentWrapper(groupName, 'card', 'yixinid');
    var articles = [
      {
        "title": "Happy Day",
        "description": "Is Really A Happy Day",
        "url": "URL",
        "picurl": "PIC_URL"
      },
      {
        "title": "Happy Day",
        "description": "Is Really A Happy Day",
        "url": "URL",
        "picurl": "PIC_URL"
      }
    ];
    var news = groupContentWrapper(groupName, 'news', articles);
    before(function() {
      var scope = nock('https://api.yixin.im')
        .filteringPath(/\?(grant_type=[^&]*&appid=[^&]*&secret=[^&]*)|\?(access_token=[^&]*)/g, '')
        .get('/cgi-bin/token', '')
        .reply(200, {
          access_token: "ACCESS_TOKEN",
          expires_in: 86400
        })
        .post('/cgi-bin/message/group/send', text)
        .reply(200, {
          errcode: 0,
          errmsg: 'ok'
        })
        .post('/cgi-bin/message/group/send', card)
        .reply(200, {
          errcode: 0,
          errmsg: 'ok'
        })
        .post('/cgi-bin/message/group/send', news)
        .reply(200, {
          errcode: 0,
          errmsg: 'ok'
        });
    });

    describe('##send text', function() {
      it('should be ok', function(done) {
        api.sendGroupText(groupName, 'hello nodejs', function(err, data) {
          should.not.exist(err);
          data.errcode.should.eql(0);
          data.errmsg.should.eql('ok');
          done();
        });
      });
    });
    describe('##send news', function() {
      it('should be ok', function(done) {
        api.sendGroupNews(groupName, articles, function(err, data) {
          should.not.exist(err);
          data.errcode.should.eql(0);
          data.errmsg.should.eql('ok');
          done();
        });
      });
    });
    describe('##send card', function() {
      it('should be ok', function(done) {
        api.sendGroupCard(groupName, 'yixinid', function(err, data) {
          should.not.exist(err);
          data.errcode.should.eql(0);
          data.errmsg.should.eql('ok');
          done();
        });
      });
    });
  });
});
